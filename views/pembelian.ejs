<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1><i class="bi bi-cart"></i> Management Pembelian</h1>
        <p class="text-muted">Input, proses, dan batalkan pembelian</p>
    </div>
    <button class="btn btn-primary" data-bs-toggle="modal"
        data-bs-target="#tambahModal">
        <i class="bi bi-plus-circle"></i> Tambah Pembelian
    </button>
</div>

<div class="card mb-4">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs">
            <li class="nav-item">
                <a
                    class="nav-link <%= currentStatus === 'all' ? 'active' : '' %>"
                    href="/pembelian?status=all">
                    Semua
                </a>
            </li>
            <li class="nav-item">
                <a
                    class="nav-link <%= currentStatus === 'pending' ? 'active' : '' %>"
                    href="/pembelian?status=pending">
                    Pending
                </a>
            </li>
            <li class="nav-item">
                <a
                    class="nav-link <%= currentStatus === 'diproses' ? 'active' : '' %>"
                    href="/pembelian?status=diproses">
                    Diproses
                </a>
            </li>
            <li class="nav-item">
                <a
                    class="nav-link <%= currentStatus === 'selesai' ? 'active' : '' %>"
                    href="/pembelian?status=selesai">
                    Selesai
                </a>
            </li>
            <li class="nav-item">
                <a
                    class="nav-link <%= currentStatus === 'dibatalkan' ? 'active' : '' %>"
                    href="/pembelian?status=dibatalkan">
                    Dibatalkan
                </a>
            </li>
        </ul>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>No. Transaksi</th>
                        <th>Produk</th>
                        <th>Jumlah</th>
                        <th>Harga Satuan</th>
                        <th>Total Harga</th>
                        <th>Status</th>
                        <th>Tanggal</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (pembelian.length === 0) { %>
                    <tr>
                        <td colspan="8" class="text-center">Tidak ada data
                            pembelian</td>
                    </tr>
                    <% } %>

                    <% pembelian.forEach(function(item) { %>
                    <tr>
                        <td><strong><%= item.no_transaksi %></strong></td>
                        <td>
                            <div><%= item.nama_produk %></div>
                            <small class="text-muted"><%= item.kode_produk
                                %></small>
                        </td>
                        <td><%= item.jumlah %></td>
                        <td>Rp <%= item.harga_satuan.toLocaleString('id-ID')
                            %></td>
                        <td><strong>Rp <%=
                                item.total_harga.toLocaleString('id-ID')
                                %></strong></td>
                        <td>
                            <span class="badge 
                                    <%= item.status === 'selesai' ? 'bg-success' : 
                                       item.status === 'dibatalkan' ? 'bg-danger' : 
                                       item.status === 'diproses' ? 'bg-warning' : 'bg-secondary' %>">
                                <%= item.status %>
                            </span>
                        </td>
                        <td><%= new
                            Date(item.tanggal_pembelian).toLocaleDateString('id-ID')
                            %></td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <% if (item.status === 'pending' || item.status
                                === 'diproses') { %>
                                <form action="/pembelian/update-status"
                                    method="POST" class="d-inline">
                                    <input type="hidden" name="id"
                                        value="<%= item.id %>">
                                    <input type="hidden" name="status"
                                        value="selesai">
                                    <button type="submit"
                                        class="btn btn-success btn-sm"
                                        onclick="return confirm('Tandai pembelian ini sebagai selesai?')">
                                        <i class="bi bi-check"></i>
                                    </button>
                                </form>
                                <form action="/pembelian/update-status"
                                    method="POST" class="d-inline">
                                    <input type="hidden" name="id"
                                        value="<%= item.id %>">
                                    <input type="hidden" name="status"
                                        value="dibatalkan">
                                    <button type="submit"
                                        class="btn btn-danger btn-sm"
                                        onclick="return confirm('Batalkan pembelian ini?')">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </form>
                                <% } %>

                                <% if (item.status === 'pending') { %>
                                <form action="/pembelian/update-status"
                                    method="POST" class="d-inline">
                                    <input type="hidden" name="id"
                                        value="<%= item.id %>">
                                    <input type="hidden" name="status"
                                        value="diproses">
                                    <button type="submit"
                                        class="btn btn-warning btn-sm">
                                        <i class="bi bi-arrow-right"></i>
                                    </button>
                                </form>
                                <% } %>
                            </div>
                        </td>
                    </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Tambah Pembelian -->
<div class="modal fade" id="tambahModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Tambah Pembelian Baru</h5>
                <button type="button" class="btn-close"
                    data-bs-dismiss="modal"></button>
            </div>
            <form action="/pembelian/tambah" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="produk_id" class="form-label">Pilih
                            Produk</label>
                        <select class="form-select" id="produk_id"
                            name="produk_id" required>
                            <option value>-- Pilih Produk --</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="jumlah" class="form-label">Jumlah</label>
                        <input type="number" class="form-control" id="jumlah"
                            name="jumlah" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="harga_satuan" class="form-label">Harga
                            Satuan</label>
                        <input type="number" class="form-control"
                            id="harga_satuan" name="harga_satuan" required>
                    </div>
                    <div class="mb-3">
                        <label for="total_harga" class="form-label">Total
                            Harga</label>
                        <input type="text" class="form-control" id="total_harga"
                            readonly>
                    </div>
                    <div class="mb-3">
                        <label for="catatan" class="form-label">Catatan
                            (Opsional)</label>
                        <textarea class="form-control" id="catatan"
                            name="catatan" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan
                        Pembelian</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load produk untuk dropdown
    fetch('/api/produk')
        .then(response => response.json())
        .then(produk => {
            const select = document.getElementById('produk_id');
            produk.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.kode_produk} - ${p.nama_produk} (Rp ${p.harga.toLocaleString('id-ID')})`;
                select.appendChild(option);
            });
        });
    
    // Event listener untuk produk selection
    document.getElementById('produk_id').addEventListener('change', function() {
        const produkId = this.value;
        if (produkId) {
            fetch(`/api/produk/${produkId}`)
                .then(response => response.json())
                .then(produk => {
                    document.getElementById('harga_satuan').value = produk.harga;
                    calculateTotal();
                });
        }
    });
    
    // Event listener untuk kalkulasi total
    const jumlahInput = document.getElementById('jumlah');
    const hargaInput = document.getElementById('harga_satuan');
    
    jumlahInput.addEventListener('input', calculateTotal);
    hargaInput.addEventListener('input', calculateTotal);
    
    function calculateTotal() {
        const jumlah = parseInt(jumlahInput.value) || 0;
        const harga = parseInt(hargaInput.value) || 0;
        const total = jumlah * harga;
        document.getElementById('total_harga').value = `Rp ${total.toLocaleString('id-ID')}`;
    }
});
</script>